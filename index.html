<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>ML Michi Studio</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous">

  <style>
  .o {
    position: relative;
  }
  .o::before {
    content: 'O';
    position: absolute;
    top: -0.17em;
    left: 0;
    right: 0;
    bottom: 0;
    margin: auto;
    font-size: 30px; 
    font-weight: bold;
    color: rgba(0,0,255,0.5);
  }
  .x {
    position: relative;
  }
  .x::before {
    content: 'X';
    position: absolute;
    top: -0.17em;
    left: 0;
    right: 0;
    bottom: 0;
    margin: auto;
    font-size: 30px; 
    font-weight: bold;
    color: rgba(255,0,0,0.5);
  }
  .winner-x {
    background-color: rgba(255,0,0,0.3);
  }
  .winner-o {
    background-color: rgba(0,0,255,0.3);
  }
  </style>
</head>
<body>
  <div id="app">

  <header>
    <div class="bg-dark" :class="{'collapse': collapse}">
      <div class="container">
        <div class="row">
          <div class="col-sm-8 col-md-7 py-4">
            <h4 class="text-white">Acerca de mi</h4>
            <p class="text-muted">Aprendo a jugar Michi. Me programó Rulo.</p>
          </div>
          <div class="col-sm-4 offset-md-1 py-4">
            <h4 class="text-white">Contacto</h4>
            <ul class="list-unstyled">
              <li><a href="https://twitter.com/rulokoba" class="text-white">@rulokoba</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="navbar navbar-dark bg-dark shadow-sm">
      <div class="container d-flex justify-content-between">
        <a href="#" class="navbar-brand d-flex align-items-center">
          <strong># ML Michi Studio</strong>
        </a>
        <button class="navbar-toggler" type="button" @click="collapse=!collapse">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </div>
  </header>

  <main class="mt-3">
    <div class="container">

      <div class="game border p-2">

        <table>
          <tbody>
            <tr>
              <td><button class="btn" :class="cellClassName(1)" @click="play(1)">1</button></td>
              <td><button class="btn" :class="cellClassName(2)" @click="play(2)">2</button></td>
              <td><button class="btn" :class="cellClassName(3)" @click="play(3)">3</button></td>
            </tr>
            <tr>
              <td><button class="btn" :class="cellClassName(4)" @click="play(4)">4</button></td>
              <td><button class="btn" :class="cellClassName(5)" @click="play(5)">5</button></td>
              <td><button class="btn" :class="cellClassName(6)" @click="play(6)">6</button></td>
            </tr>
            <tr>
              <td><button class="btn" :class="cellClassName(7)" @click="play(7)">7</button></td>
              <td><button class="btn" :class="cellClassName(8)" @click="play(8)">8</button></td>
              <td><button class="btn" :class="cellClassName(9)" @click="play(9)">9</button></td>
            </tr>
          </tbody>
        </table>

        <div class="buttons mt-2">
          <button class="btn btn-warning btn-sm" @click="playRandom">Juega Random</button>
          <button class="btn btn-warning btn-sm" @click="playAI">Juega AI</button>
        </div>

        <div class="buttons mt-2">
          <button class="btn btn-info btn-sm" @click="startTrainingRandom">Entrena Random</button>
          <button class="btn btn-info btn-sm" @click="startTrainingAI">Entrena AI</button>
          <span v-if="trainingMovs > 0">{{ trainingMovs }} movimientos</span>
          <button class="btn btn-info btn-sm" @click="stopTraining">Detener entrenamiento</button>
        </div>

        <h3>Juego</h3>
        <code>{{game}}</code>
        
        <h3>Disponible</h3>
        <code>{{available}}</code>

        <h3>Ganador</h3>
        <code>{{winner}}</code>
        <code>{{score}}</code>

        <div class="buttons mt-2">
          <button class="btn btn-primary btn-sm" @click="newGame">Nuevo juego</button>
        </div>
      </div>

      <div class="memory border p-2 mt-1">
        <h3>Memoria</h3>
        <div v-html="memoryMap"></div>
        <pre>{{memory}}</pre>
      </div>

    </div>
  </main>

  <footer class="text-muted">
    <div class="container-fluid">
      <hr>
      <small>Michi</small>
    </div>
  </footer>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

  <script>
  const app = new Vue({
    el: '#app',
    data: {
      collapse: true,

      weightFactor: 10,
      total: [1, 2, 3, 4, 5, 6, 7, 8, 9],
      goals: [
        [1, 2, 3],
        [1, 4, 7],
        [1, 5, 9],
        [2, 5, 8],
        [3, 5, 7],
        [3, 6, 9],
        [4, 5, 6],
        [7, 8, 9],
      ],
      game: [],
      available: null,
      memory: [],
      winner: null,
      score: {x: 0, o: 0},
      currentMemoryList: null,
      finished: false,
      training: false,
      trainingMovs: 0,
      minMovDelay: 1,
    },
    computed: {
      memoryMap: function() {
        let html = this.renderMemoryList(this.memory);
        return html;
      },
    },
    mounted: function() {
      this.currentMemoryList = this.memory;
      this.available = [...this.total];
      this.winner = this.getWinner();
    },
    methods: {
      renderMemoryList: function(list) {
        let html = '';
        if (list && list.length > 0) {
          html = `<ul>`;
          for (let item of list) {
            html += `<li>`;
            html += `${item.name} <small>(${item.weight})</small>`;
            if (item.children) {
              html += this.renderMemoryList(item.children);
            }
            html += `</li>`;
          }
          html += `</ul>`;
        }
        return html;
      },
      renderGameMap: function(list) {
        let html;
        html = `<pre>${JSON.stringify(list)}</pre>`
        return html;
      },
      cellClassName: function (n) {
        const m = this.game.indexOf(n);
        if (m === -1) {
          return '';
        }

        let result = '';
        if (m % 2 === 0) {
          result += 'x';
        } else {
          result += 'o';
        }

        if (this.winner.x.indexOf(n) != -1) {
          console.log('x');
          result += ' winner-x';
        }
        if (this.winner.o.indexOf(n) != -1) {
          console.log('o');
          result += ' winner-o';
        }
        return result;
      },

      isValid: function(n) {
        return this.available.indexOf(n) != -1;
      },
      addToGame: function (n) {
        this.available.splice(this.available.indexOf(n), 1);
        this.game.push(n);
      },

      isGameInMemory: function() {
        return false;
      },
      saveInMemory: function(n) {
        let list = this.currentMemoryList;
        const found = list.find(x => x.name === n);
        if (!found) {
          const newItem = {
            name: n,
            weight: 1,
            children: []
          };
          list.push(newItem);
          this.currentMemoryList = newItem.children;
        } else {
          found.weight++;
          this.currentMemoryList = found.children;
        }
      },
      isGameFinished: function() {
        return false;
      },
      newGame: function() {
        this.game = [];
        this.available = [...this.total];
        this.finished = false;
        this.currentMemoryList = this.memory;
      },
      saveVictory: function() {
        this.saveInMemory('*');
        this.finished = true;
      },
      getWinner: function() {
        const result = {x: [], o: []};

        // separa
        const xs = [];
        const os = [];
        for (let i = 0; i < this.game.length; i++) {
          const n = this.game[i];
          if (i % 2 == 0) {
            xs.push(n);
          } else {
            os.push(n);
          }
        }
        // console.log(xs, os);

        // coteja
        for (let goal of this.goals) {
          // quita del goal cada item presente en el juego
          // si lo que queda es vacio, entonces goal
          if (goal.filter(n => xs.indexOf(n) == -1).length == 0) {
            result.x.push(...goal);
            this.score.x++;
          }
          if (goal.filter(n => os.indexOf(n) == -1).length == 0) {
            result.o.push(...goal);
            this.score.o++;
          }
        }
        return result;
      },

      play: function(n) {
        if (this.finished) {
          return -1;
        }
        if (!this.isValid(n)) {
          return n;
        }

        this.addToGame(n);
        
        this.saveInMemory(n);

        this.winner = this.getWinner();

        if (this.winner.x.length > 0
          || this.winner.o.length > 0) {
          this.saveVictory();
        }

        return n;
      },

      chooseRandomNext: function () {
        const available = this.available;
        if (available.length == 0) {
          console.log('No hay jugada disponible');
          this.finished = true;
          return -1;
        }
        const r = Math.floor(available.length * Math.random());
        return available[r];
      },
      playRandom: function() {
        if (this.finished) {
          return -1;
        }

        const n = this.chooseRandomNext();
        
        if (!this.isValid(n)) {
          return n;
        }

        this.addToGame(n);

        this.saveInMemory(n);

        this.winner = this.getWinner();

        if (this.winner.x.length > 0
          || this.winner.o.length > 0) {
          this.saveVictory();
        }

        return n;
      },

      chooseAINext: function () {
        // los pesos multiplican las probabilidades de la opción
        // y hay que elegir al azar entre las opciones ya multiplicadas
        const weights = this.available.map(n => {
          const found = this.currentMemoryList.find(m => m.name == n);
          if (found) {
            return found.weight * this.weightFactor;
          } else {
            return 1;
          }
        });
        const weigthSum = weights.reduce((ac, n) => ac += n, 0);
        const randomVIndex = Math.floor(Math.random() * weigthSum);
        let choosed;
        for (let i = 0, w = 0; i < weights.length; i++) {
          w += weights[i];
          if (w > randomVIndex) {
            choosed = this.available[i];
            break;
          }
        }
        console.log({weights}, {weigthSum}, {choosed});
        return choosed;
      },
      playAI: function() {
        if (this.finished) {
          return -1;
        }

        const n = this.chooseAINext();

        if (!this.isValid(n)) {
          return n;
        }

        this.addToGame(n);

        this.saveInMemory(n);

        this.winner = this.getWinner();

        if (this.winner.x.length > 0
          || this.winner.o.length > 0) {
          this.saveVictory();
        }

        return n;
      },

      startTrainingRandom: function() {
        this.training = true;
        this.trainingRandom();
      },
      startTrainingAI: function() {
        this.training = true;
        this.trainingAI();
      },
      stopTraining: function() {
        this.training = false;
      },

      _trainingRandom: function() {
        return new Promise((resolve, reject) => {
          setTimeout(()=> {
            const n = this.playRandom();
            if (this.finished) {
              this.newGame();
            }
            this.trainingMovs++;
            resolve(n);
          }, this.minMovDelay);
        });
      },
      trainingRandom: async function() {
        try {
          while (this.training) {
            const n = await this._trainingRandom();
          }
        } catch (error) {
          console.log(error);          
        }
      }

    },
  });
  </script>
</body>
</html>